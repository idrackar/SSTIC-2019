LATEXMK ?= latexmk
PANDOC ?= pandoc

STY_FILES := $(wildcard *.sty)
RST_SOURCES := $(wildcard *.rst)
PDF_FROM_RST := $(RST_SOURCES:%.rst=%.pdf)

THEME_NAME = anssi
TEMPLATE = default.beamer
VARIABLES = -V 'theme:$(THEME_NAME)' -V 'section-titles:'
# Make the slides bigger (and the text smaller)
# VARIABLES += -V 'geometry:paperwidth=160mm' -V 'geometry:paperheight=120mm'
# Hide the table of content
VARIABLES += -V 'toc:'

PANDOCFLAGS = --slide-level=2 -s --toc --template=$(TEMPLATE) $(VARIABLES) -t beamer --pdf-engine=xelatex

all: $(PDF_FROM_RST)

#%.pdf: %.rst $(TEMPLATE) $(STY_FILES)
#	$(PANDOC) $(PANDOCFLAGS) -o $@ $<
# Make slides with notes for PDF Presenter Console (pdfpc)
%.pdf: %.rst.tex $(TEMPLATE) $(STY_FILES)
	mkdir -p tmp_out_$(@F).dir
	$(LATEXMK) -output-directory=tmp_out_$(@F).dir -pdfxe $< < /dev/null
	mv -f tmp_out_$(@F).dir/$(<F:%.rst.tex=%.rst.pdf) $@
	if [ -e tmp_out_$(@F).dir/$(<F:%.rst.tex=%.rst.pdfpc) ] ; then mv -f tmp_out_$(@F).dir/$(<F:%.rst.tex=%.rst.pdfpc) $(@:%.pdf=%.pdfpc) ; fi
	$(RM) -r tmp_out_$(@F).dir


# Run "make slides-rst.rst.tex" to view the LaTeX-beamer file generated by pandoc
%.rst.tex: %.rst $(TEMPLATE)
	$(PANDOC) $(PANDOCFLAGS) -V 'pandocjobname:$(<:%.rst=%)' -o $@ $<

%.pdf: %.tex $(STY_FILES)
	$(LATEXMK) -pdf $< < /dev/null

clean:
	$(RM) $(PDF_FROM_TEX) $(PDF_FROM_RST) ./*.rst.tex

.PHONY: all clean
